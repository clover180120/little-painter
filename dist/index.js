(()=>{"use strict";var t;!function(t){t[t.RECTANGLE=0]="RECTANGLE",t[t.ELLIPSE=1]="ELLIPSE",t[t.SELECT=2]="SELECT",t[t.ASSOCIATION=3]="ASSOCIATION",t[t.GENERALIZATION=4]="GENERALIZATION",t[t.COMPOSITION=5]="COMPOSITION"}(t||(t={}));var e,s=(e=function(t,s){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&(t[s]=e[s])},e(t,s)},function(t,s){if("function"!=typeof s&&null!==s)throw new TypeError("Class extends value "+String(s)+" is not a constructor or null");function n(){this.constructor=t}e(t,s),t.prototype=null===s?Object.create(s):(n.prototype=s.prototype,new n)}),n=function(){function t(t,e,s){this.fromShape=t,this.toShape=e,this.ctx=s}return t.prototype.findConnectionPort=function(){if(this.fromShape.selectedShape&&this.toShape.selectedShape){for(var t=Number.MAX_VALUE,e={from:{x:0,y:0},to:{x:0,y:0}},s=0,n=Object.values(this.fromShape.selectedShape);s<n.length;s++)for(var i=n[s],o=0,a=Object.values(this.toShape.selectedShape);o<a.length;o++){var r=a[o],c=i.x-r.x,h=i.y-r.y,u=Math.sqrt(Math.pow(c,2)+Math.pow(h,2));u<t&&(t=u,e.from=i,e.to=r)}return e}return null},t}(),i=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return s(e,t),e.prototype.drawLine=function(){var t=this.findConnectionPort();t&&(this.ctx.beginPath(),this.ctx.moveTo(t.from.x,t.from.y),this.ctx.lineTo(t.to.x,t.to.y),this.ctx.stroke())},e}(n),o=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return s(e,t),e.prototype.drawLine=function(){var t=this.findConnectionPort();if(t){var e=t.to.x-t.from.x,s=t.to.y-t.from.y,n=.9*e+t.from.x,i=.9*s+t.from.y,o=t.to.x-n,a=t.to.y-i;this.ctx.beginPath(),this.ctx.moveTo(t.from.x,t.from.y),this.ctx.lineTo(n,i),this.ctx.moveTo(n+.5*a,i-.5*o),this.ctx.lineTo(n-.5*a,i+.5*o),this.ctx.lineTo(t.to.x,t.to.y),this.ctx.closePath(),this.ctx.stroke()}},e}(n),a=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return s(e,t),e.prototype.drawLine=function(){var t=this.findConnectionPort();if(t){var e=t.to.x-t.from.x,s=t.to.y-t.from.y,n=.9*e+t.from.x,i=.9*s+t.from.y,o=.95*e+t.from.x,a=.95*s+t.from.y,r=t.to.x-o,c=t.to.y-a;this.ctx.beginPath(),this.ctx.moveTo(t.from.x,t.from.y),this.ctx.lineTo(n,i),this.ctx.lineTo(o+.5*c,a-.5*r),this.ctx.lineTo(t.to.x,t.to.y),this.ctx.lineTo(o-.5*c,a+.5*r),this.ctx.lineTo(n,i),this.ctx.stroke()}},e}(n),r=function(){var t=function(e,s){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&(t[s]=e[s])},t(e,s)};return function(e,s){if("function"!=typeof s&&null!==s)throw new TypeError("Class extends value "+String(s)+" is not a constructor or null");function n(){this.constructor=e}t(e,s),e.prototype=null===s?Object.create(s):(n.prototype=s.prototype,new n)}}(),c=function(t,e,s,n,i,o,a,r,c,h){this.startX=t,this.startY=e,this.selectedStartX=s,this.selectedStartY=n,this.width=i,this.height=o,this.zIndex=a,this.selected=r,this.selectedShape=c,this.name=h},h=function(t){function e(e,s,n,i,o,a,r,c,h,u,l){var d=t.call(this,s,n,i,o,a,r,h,c)||this;return d.ctx=e,d.selectedShape=u,d.name=l,d}return r(e,t),e.prototype.isShapeSelected=function(t,e){var s=new Path2D;return s.rect(this.startX,this.startY,this.width,this.height),this.ctx.isPointInPath(s,t,e)},e.prototype.draw=function(){this.ctx&&(this.ctx.beginPath(),this.ctx.rect(this.startX,this.startY,this.width,this.height),this.ctx.fillStyle="#FFF",this.ctx.fillRect(this.startX,this.startY,this.width,this.height),this.ctx.stroke(),this.ctx.save())},e.prototype.drawPoints=function(){var t=this;this.selected&&this.selectedShape&&Object.values(this.selectedShape).map((function(e){var s=e.x,n=e.y;t.ctx&&(t.ctx.beginPath(),t.ctx.arc(s,n,3,0,2*Math.PI,!1),t.ctx.fillStyle="#3a3a3a",t.ctx.fill(),t.ctx.stroke())}))},e.prototype.calcPointsPosition=function(t,e){return{top:{x:t+this.width/2,y:e},bottom:{x:t+this.width/2,y:e+this.height},left:{x:t,y:e+this.height/2},right:{x:t+this.width,y:e+this.height/2}}},e.prototype.fillText=function(){this.name&&(this.ctx.fillStyle="#3a3a3a",this.ctx.font="20px Arial",this.ctx.fillText(this.name,this.startX+this.width/2-4*this.name.length,this.startY+this.height/2))},e}(c),u=function(t){function e(e,s,n,i,o,a,r,c,h,u,l,d,p){var v=t.call(this,s,n,i,o,a,r,l,u)||this;return v.ctx=e,v.centerX=c,v.centerY=h,v.selectedShape=d,v.name=p,v}return r(e,t),e.prototype.isShapeSelected=function(t,e){var s=new Path2D;return s.ellipse(this.startX,this.startY,this.width,this.height,0,0,2*Math.PI),this.ctx.isPointInPath(s,t,e)},e.prototype.draw=function(){this.ctx&&(this.ctx.beginPath(),this.ctx.ellipse(this.startX,this.startY,this.width,this.height,0,0,2*Math.PI,!1),this.ctx.fillStyle="#FFF",this.ctx.fill(),this.ctx.stroke(),this.ctx.save())},e.prototype.drawPoints=function(){var t=this;this.selected&&this.selectedShape&&Object.values(this.selectedShape).map((function(e){var s=e.x,n=e.y;t.ctx&&(t.ctx.beginPath(),t.ctx.arc(s,n,3,0,2*Math.PI,!1),t.ctx.fillStyle="#3a3a3a",t.ctx.fill(),t.ctx.stroke())}))},e.prototype.calcPointsPosition=function(t,e){return{top:{x:t,y:e-this.height},bottom:{x:t,y:e+this.height},left:{x:t-this.width,y:e},right:{x:t+this.width,y:e}}},e.prototype.fillText=function(){this.name&&(this.ctx.fillStyle="#3a3a3a",this.ctx.font="20px Arial",this.ctx.fillText(this.name,this.startX-4*this.name.length,this.startY))},e}(c),l=function(t,e,s){var n=function(t,e,s){if(s||2===arguments.length)for(var n,i=0,o=e.length;i<o;i++)!n&&i in e||(n||(n=Array.prototype.slice.call(e,0,i)),n[i]=e[i]);return t.concat(n||Array.prototype.slice.call(e))}([],s,!0).sort((function(t,e){return function(t,e){return e-t}(t.zIndex,e.zIndex)})).findIndex((function(s){return s.isShapeSelected(t,e)}));return-1===n?null:s[n=s.length-n-1]},d=function(t){t.forEach((function(t){t.selected=!1}))},p=function(t,e){var s=t.pageX-e.canvasRect.left,n=t.pageY-e.canvasRect.top;return{mouseX:s,mouseY:n,width:Math.abs(s-e.state.startX),height:Math.abs(n-e.state.startY),isRight:s>=e.state.startX,isBottom:n>e.state.startY}},v=function(t,e){var s=t.pageX-e.canvasRect.left,n=t.pageY-e.canvasRect.top,i=Math.abs(s-e.state.startX),o=Math.abs(n-e.state.startY);return{mouseX:s,mouseY:n,width:i,height:o,centerX:s+i/2,centerY:n+o/2,isRight:s>=e.state.startX,isBottom:n>e.state.startY}},f=function(t,e){!function(t){t.forEach((function(t){t.draw(),t.drawPoints(),t.fillText()}))}(t),function(t){t.forEach((function(t){t.drawLine()}))}(e)},m=function(t){var e=t.ctx,s=t.canvasRect;e&&e.clearRect(0,0,s.width,s.height)},g=function(e){return{onMousedown:function(t,e){return function(t,e){var s=t.pageX-e.canvasRect.left,n=t.pageY-e.canvasRect.top,i=l(s,n,e.state.shapeList);d(e.state.shapeList),null!==i&&(i.selected=!0,e.state.isDragging=!0,e.state.shapeList.forEach((function(t){t.selected&&(t.selectedStartX=s,t.selectedStartY=n)})),m(e),f(e.state.shapeList,e.state.lineList),e.state.isSelectingMultiShape=!1)}(t,e)},onMouseup:function(s,n){return function(e,s,n){s.state.isDragging=!1;var r=e.pageX-s.canvasRect.left,c=e.pageY-s.canvasRect.top;s.state.shapeList.forEach((function(e){if(e.selected){var h=Object.assign(Object.create(Object.getPrototypeOf(e)),e),u=r-h.selectedStartX,l=c-h.selectedStartY;h.startX+=u,h.startY+=l,h.selectedShape=h.calcPointsPosition(h.startX,h.startY);var d=function(t,e){for(var s=0,n=e;s<n.length;s++){var i=n[s];if(!i.selected&&!(t.startX+t.width<i.startX||t.startX>i.startX+i.width||t.startY+t.height<i.startY||t.startY>i.startY+i.height))return i}return null}(h,s.state.shapeList);if(d&&s.ctx)switch(n){case t.ASSOCIATION:var p=new i(e,d,s.ctx);s.state.lineList.push(p);break;case t.GENERALIZATION:var v=new o(e,d,s.ctx);s.state.lineList.push(v);break;case t.COMPOSITION:var f=new a(e,d,s.ctx);s.state.lineList.push(f)}}})),m(s),f(s.state.shapeList,s.state.lineList)}(s,n,e)},onMousemove:function(t,e){}}},E=g(t.ASSOCIATION),L=g(t.GENERALIZATION),O=g(t.COMPOSITION),x=new(function(){function e(t){var e=this;this.rectangleOnMousedown=function(t){!function(t,e){d(e.state.shapeList);var s=p(t,e),n=s.mouseX,i=s.mouseY;e.state.startX=n,e.state.startY=i,e.state.isDrawing=!0}(t,e)},this.rectangleOnMouseup=function(t){!function(t,e){e.state.isDrawing=!1;var s=p(t,e),n=s.width,i=s.height,o=s.isRight,a=s.isBottom,r=new h(e.ctx,e.state.startX,e.state.startY,0,0,o?n:-n,a?i:-i,!1,e.popZIndex());r.calcPointsPosition(e.state.startX,e.state.startY),r.selectedShape=r.calcPointsPosition(r.startX,r.startY),e.state.shapeList.push(r),f(e.state.shapeList,e.state.lineList)}(t,e)},this.rectangleOnMousemove=function(t){!function(t,e){if(e.state.isDrawing&&e.state.startX&&e.state.startY&&e.ctx){m(e);var s=p(t,e),n=s.width,i=s.height,o=s.isRight,a=s.isBottom;new h(e.ctx,e.state.startX,e.state.startY,0,0,o?n:-n,a?i:-i,!1,e.popZIndex()).draw(),f(e.state.shapeList,e.state.lineList)}}(t,e)},this.ellipseOnMousedown=function(t){!function(t,e){d(e.state.shapeList);var s=v(t,e),n=s.mouseX,i=s.mouseY;e.state.startX=n,e.state.startY=i,e.state.isDrawing=!0}(t,e)},this.ellipseOnMouseup=function(t){!function(t,e){e.state.isDrawing=!1;var s=v(t,e),n=s.centerX,i=s.centerY,o=s.width,a=s.height,r=new u(e.ctx,e.state.startX,e.state.startY,0,0,o,a,n,i,!1,e.popZIndex());r.selectedShape=r.calcPointsPosition(r.startX,r.startY),e.state.shapeList.push(r),f(e.state.shapeList,e.state.lineList)}(t,e)},this.ellipseOnMousemove=function(t){!function(t,e){if(e.state.isDrawing){var s=v(t,e),n=s.width,i=s.height,o=s.centerX,a=s.centerY;e.state.startX&&e.state.startY&&e.ctx&&(m(e),new u(e.ctx,e.state.startX,e.state.startY,0,0,n,i,o,a,!1,e.popZIndex()).draw(),f(e.state.shapeList,e.state.lineList))}}(t,e)},this.selectOnMousemove=function(t){!function(t,e){if(!e.state.isSelectingMultiShape){if(!e.state.isDragging)return;e.state.shapeList.forEach((function(s){if(s.selected){var n=t.pageX-e.canvasRect.left,i=t.pageY-e.canvasRect.top,o=n-s.selectedStartX,a=i-s.selectedStartY;s.startX+=o,s.startY+=a,s.selectedStartX+=o,s.selectedStartY+=a,s.selectedShape=s.calcPointsPosition(s.startX,s.startY)}})),m(e),f(e.state.shapeList,e.state.lineList)}if(e.state.isDrawing&&e.state.isSelectingMultiShape&&e.state.startX&&e.state.startY&&e.ctx){m(e);var s=p(t,e),n=s.width,i=s.height,o=s.isRight,a=s.isBottom;new h(e.ctx,e.state.startX,e.state.startY,0,0,o?n:-n,a?i:-i,!1,e.popZIndex()).draw(),f(e.state.shapeList,e.state.lineList)}}(t,e)},this.selectOnMouseup=function(t){!function(t,e){var s=t.pageX-e.canvasRect.left,n=t.pageY-e.canvasRect.top;e.state.isSelectingMultiShape||(e.state.isDragging=!1,e.state.shapeList.forEach((function(t){if(t.selected){var e=s-t.selectedStartX,i=n-t.selectedStartY;t.startX+=e,t.startY+=i,t.selectedShape=t.calcPointsPosition(t.startX,t.startY)}}))),e.state.isSelectingMultiShape&&(e.state.isDrawing=!1,e.state.shapeList.forEach((function(t){var i=function(t,e,s,n){var i=t.startX,o=t.startY,a=t.width,r=t.height,c=Math.min(s,e.state.startX),h=Math.max(s,e.state.startX),u=Math.min(n,e.state.startY),l=Math.max(n,e.state.startY);return i>c&&i+a<h&&o>u&&o+r<l}(t,e,s,n);i&&(t.selected=!0),t.selected&&(t.selectedShape=t.calcPointsPosition(t.startX,t.startY))}))),m(e),f(e.state.shapeList,e.state.lineList)}(t,e)},this.selectOnMousedown=function(t){!function(t,e){var s=t.pageX-e.canvasRect.left,n=t.pageY-e.canvasRect.top,i=l(s,n,e.state.shapeList);if(d(e.state.shapeList),null!==i)i.selected=!0,e.state.isDragging=!0,e.state.shapeList.forEach((function(t){t.selected&&(t.selectedStartX=s,t.selectedStartY=n)})),m(e),f(e.state.shapeList,e.state.lineList),e.state.isSelectingMultiShape=!1;else{var o=p(t,e),a=o.mouseX,r=o.mouseY;e.state.startX=a,e.state.startY=r,e.state.isDrawing=!0,e.state.isSelectingMultiShape=!0}}(t,e)},this.associationOnMousemove=function(t){E.onMousemove(t,e)},this.associationOnMouseup=function(t){E.onMouseup(t,e)},this.associationOnMousedown=function(t){E.onMousedown(t,e)},this.generalizationOnMousemove=function(t){L.onMousemove(t,e)},this.generalizationOnMouseup=function(t){L.onMouseup(t,e)},this.generalizationOnMousedown=function(t){L.onMousedown(t,e)},this.compositionOnMousemove=function(t){O.onMousemove(t,e)},this.compositionOnMouseup=function(t){O.onMouseup(t,e)},this.compositionOnMousedown=function(t){O.onMousedown(t,e)},this.canvas=t,this.ctx=this.canvas.getContext("2d"),this.canvasRect=this.canvas.getBoundingClientRect(),this.state={startX:0,startY:0,selectedPointX:0,selectedPointY:0,isDrawing:!1,isDragging:!1,isSelectingMultiShape:!1,shapeList:[],lineList:[],currentToolkit:void 0,zIndex:0},this.ctx&&(this.ctx.lineJoin="round",this.ctx.lineWidth=1);var s=document.getElementById("dropdown-btn"),n=document.querySelector(".dropdown-content"),i=document.getElementById("dropdown-name"),o=document.getElementById("dialog"),a=document.getElementById("submit"),r=document.getElementById("close-dialog");null==s||s.addEventListener("click",(function(){null==n||n.classList.toggle("show")}));var c={isDialogOpened:!1};null==i||i.addEventListener("click",(function(){e.state.shapeList.forEach((function(t){t.selected&&(c.isDialogOpened=!0,c.isDialogOpened&&(null==n||n.classList.remove("show"),null==o||o.showModal()))}))})),null==a||a.addEventListener("click",(function(){var t=document.getElementById("name"),s=null==t?void 0:t.value;s&&(null==o||o.close(),e.state.shapeList.forEach((function(t){t.selected&&(t.name=s)}))),t&&(t.value=""),e.state.shapeList.forEach((function(t){t.name&&(t.draw(),t.drawPoints(),t.fillText())}))})),null==r||r.addEventListener("click",(function(){null==o||o.close()}))}return e.prototype.popZIndex=function(){return this.state.zIndex++},e.prototype.registerEventListeners=function(e){switch(e){case t.RECTANGLE:this.canvas.addEventListener("mousedown",this.rectangleOnMousedown),this.canvas.addEventListener("mouseup",this.rectangleOnMouseup),this.canvas.addEventListener("mousemove",this.rectangleOnMousemove);break;case t.ELLIPSE:this.canvas.addEventListener("mousedown",this.ellipseOnMousedown),this.canvas.addEventListener("mouseup",this.ellipseOnMouseup),this.canvas.addEventListener("mousemove",this.ellipseOnMousemove);break;case t.SELECT:this.canvas.addEventListener("mousedown",this.selectOnMousedown),this.canvas.addEventListener("mouseup",this.selectOnMouseup),this.canvas.addEventListener("mousemove",this.selectOnMousemove);break;case t.ASSOCIATION:this.canvas.addEventListener("mousedown",this.associationOnMousedown),this.canvas.addEventListener("mouseup",this.associationOnMouseup),this.canvas.addEventListener("mousemove",this.associationOnMousemove);break;case t.GENERALIZATION:this.canvas.addEventListener("mousedown",this.generalizationOnMousedown),this.canvas.addEventListener("mouseup",this.generalizationOnMouseup),this.canvas.addEventListener("mousemove",this.generalizationOnMousemove);break;case t.COMPOSITION:this.canvas.addEventListener("mousedown",this.compositionOnMousedown),this.canvas.addEventListener("mouseup",this.compositionOnMouseup),this.canvas.addEventListener("mousemove",this.compositionOnMousemove)}},e.prototype.unregisterEventListeners=function(e){switch(e){case t.RECTANGLE:this.canvas.removeEventListener("mousedown",this.rectangleOnMousedown),this.canvas.removeEventListener("mouseup",this.rectangleOnMouseup),this.canvas.removeEventListener("mousemove",this.rectangleOnMousemove);break;case t.ELLIPSE:this.canvas.removeEventListener("mousedown",this.ellipseOnMousedown),this.canvas.removeEventListener("mouseup",this.ellipseOnMouseup),this.canvas.removeEventListener("mousemove",this.ellipseOnMousemove);break;case t.SELECT:this.canvas.removeEventListener("mousedown",this.selectOnMousedown),this.canvas.removeEventListener("mouseup",this.selectOnMouseup),this.canvas.removeEventListener("mousemove",this.selectOnMousemove);break;case t.ASSOCIATION:this.canvas.removeEventListener("mousedown",this.associationOnMousedown),this.canvas.removeEventListener("mouseup",this.associationOnMouseup),this.canvas.removeEventListener("mousemove",this.associationOnMousemove);break;case t.GENERALIZATION:this.canvas.removeEventListener("mousedown",this.generalizationOnMousedown),this.canvas.removeEventListener("mouseup",this.generalizationOnMouseup),this.canvas.removeEventListener("mousemove",this.generalizationOnMousemove);break;case t.COMPOSITION:this.canvas.removeEventListener("mousedown",this.compositionOnMousedown),this.canvas.removeEventListener("mouseup",this.compositionOnMouseup),this.canvas.removeEventListener("mousemove",this.compositionOnMousemove)}},e}())(document.getElementById("canvas"));[{node:document.getElementById("rectangle"),listeners:{click:function(){x.state.currentToolkit!==t.RECTANGLE&&x.unregisterEventListeners(x.state.currentToolkit),x.registerEventListeners(t.RECTANGLE),x.state.currentToolkit=t.RECTANGLE}}},{node:document.querySelector(".toolbar"),listeners:{click:function(t){document.querySelectorAll(".toolbar-item").forEach((function(t){return t.classList.remove("active")})),t.target.classList.add("active")}}},{node:document.getElementById("ellipse"),listeners:{click:function(){x.state.currentToolkit!==t.ELLIPSE&&x.unregisterEventListeners(x.state.currentToolkit),x.registerEventListeners(t.ELLIPSE),x.state.currentToolkit=t.ELLIPSE}}},{node:document.getElementById("select"),listeners:{click:function(){x.state.currentToolkit!==t.SELECT&&x.unregisterEventListeners(x.state.currentToolkit),x.registerEventListeners(t.SELECT),x.state.currentToolkit=t.SELECT}}},{node:document.getElementById("association"),listeners:{click:function(){x.state.currentToolkit!==t.ASSOCIATION&&x.unregisterEventListeners(x.state.currentToolkit),x.registerEventListeners(t.ASSOCIATION),x.state.currentToolkit=t.ASSOCIATION}}},{node:document.getElementById("generalization"),listeners:{click:function(){x.state.currentToolkit!==t.GENERALIZATION&&x.unregisterEventListeners(x.state.currentToolkit),x.registerEventListeners(t.GENERALIZATION),x.state.currentToolkit=t.GENERALIZATION}}},{node:document.getElementById("composition"),listeners:{click:function(){x.state.currentToolkit!==t.COMPOSITION&&x.unregisterEventListeners(x.state.currentToolkit),x.registerEventListeners(t.COMPOSITION),x.state.currentToolkit=t.COMPOSITION}}}].forEach((function(t){Object.entries(t.listeners).forEach((function(e){var s,n=e[0],i=e[1];null===(s=t.node)||void 0===s||s.addEventListener(n,i)}))}))})();